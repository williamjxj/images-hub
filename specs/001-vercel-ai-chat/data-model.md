# Data Model: Chat Feature Using Vercel AI Gateway + DeepSeek LLM

**Date**: 2025-01-27  
**Feature**: Chat Feature Using Vercel AI Gateway + DeepSeek LLM  
**Branch**: `001-vercel-ai-chat`

## Overview

This document defines the data entities and their relationships for the chat feature. The implementation uses in-memory client-side state management (no persistent storage per specification out-of-scope).

## Entities

### ChatMessage

Represents a single message in a conversation.

**Fields**:
- `id: string` - Unique identifier for the message (generated by AI SDK)
- `role: 'user' | 'assistant'` - Sender role (user or AI assistant)
- `content: string` - Message text content
- `timestamp: number` - Unix timestamp when message was created (optional, can be derived)
- `parts?: MessagePart[]` - Structured message parts (for AI SDK compatibility)
  - `type: 'text'` - Part type
  - `text: string` - Text content

**Relationships**:
- Belongs to a `ChatSession`
- Ordered sequence within session

**Validation Rules**:
- Content must not be empty (FR-012)
- Content length must not exceed token limits (FR-015)
- Role must be either 'user' or 'assistant'

**State Transitions**:
- Created when user sends message or assistant responds
- Immutable after creation (no editing/deletion per spec)

**Implementation Notes**:
- Uses AI SDK `UIMessage` format for compatibility
- Text extraction: `message.parts?.filter(p => p.type === 'text').map(p => p.text).join('')`

---

### ChatSession

Represents a single conversation instance.

**Fields**:
- `messages: ChatMessage[]` - Ordered sequence of messages in the conversation
- `startedAt: number` - Unix timestamp when session started (first user message)
- `lastActivityAt: number` - Unix timestamp of last activity (message send/receive)
- `isActive: boolean` - Whether session is currently active
- `timeoutId?: NodeJS.Timeout` - Timeout reference for inactivity tracking (client-side)

**Relationships**:
- Contains multiple `ChatMessage` entities (ordered sequence)
- One active session per user (FR-016)

**Validation Rules**:
- Session starts when user sends first message (FR-013)
- Session ends when user starts new conversation or after 30 minutes inactivity (FR-014)
- Only one active session per user at a time (FR-016)

**State Transitions**:
1. **Initial**: No session exists
2. **Active**: User sends first message → session created and active
3. **Active**: User sends/receives messages → `lastActivityAt` updated, timeout reset
4. **Expired**: 30 minutes of inactivity → session marked inactive
5. **Replaced**: User starts new conversation → previous session cleared, new session created

**Implementation Notes**:
- Managed in React component state (`useState`)
- Timeout tracked with `useEffect` and `setTimeout`
- Clearing session: `setMessages([])`, reset timestamps

---

### ErrorState

Represents error information displayed to users.

**Fields**:
- `type: 'network' | 'timeout' | 'rate_limit' | 'validation' | 'service' | 'malformed'` - Error category
- `message: string` - User-friendly error message
- `retryable: boolean` - Whether user can retry the request
- `retryAfter?: number` - Seconds to wait before retry (for rate limits)
- `details?: string` - Additional error details (optional, for debugging)

**Relationships**:
- Associated with a failed chat request
- Displayed in UI when error occurs

**Validation Rules**:
- Error messages must be displayed within 1 second of detection (SC-004)
- Error messages must be user-friendly and actionable (FR-007)
- Retry option must be provided when applicable (FR-017, FR-018)

**Error Types**:
- **network**: Network connectivity issues
- **timeout**: Request exceeded 60-second timeout (FR-018)
- **rate_limit**: Rate limit exceeded (FR-011)
- **validation**: Message validation failed (FR-012, FR-015)
- **service**: AI service unavailable
- **malformed**: AI service returned invalid/empty response (FR-017)

**Implementation Notes**:
- Error state managed in React component state
- Displayed in UI with retry button when `retryable === true`
- Error details logged to console for debugging

---

## Data Flow

### Message Send Flow

1. User types message → `input` state updated
2. User submits → Validation (empty check, token limit check)
3. If valid → Add user message to `messages` array
4. Send to API → `/api/chat` POST request
5. Stream response → Update assistant message incrementally
6. Complete → Finalize assistant message in `messages` array

### Error Flow

1. Error detected → Create `ErrorState` object
2. Display error → Show error message in UI
3. If retryable → Show retry button
4. User retries → Resend original message

### Session Lifecycle Flow

1. **Start**: User sends first message → Create session, set `startedAt`, `lastActivityAt`
2. **Activity**: Each message → Update `lastActivityAt`, reset timeout
3. **Timeout**: 30 minutes inactivity → Clear session, show timeout message
4. **New Conversation**: User clicks "New Chat" → Clear `messages`, reset timestamps

---

## Constraints & Business Rules

### Message Constraints
- Maximum message length: ~8000 tokens (estimated: 32,000 characters)
- Empty messages rejected (FR-012)
- Messages exceeding token limit rejected before sending (FR-015)

### Session Constraints
- Single active session per user (FR-016)
- Session timeout: 30 minutes inactivity (FR-014)
- Session starts on first message (FR-013)
- Session ends on new conversation or timeout (FR-014)

### Error Handling Constraints
- All errors must display user-friendly messages (FR-007)
- Timeout errors must include retry option (FR-018)
- Malformed response errors must include retry option (FR-017)
- Rate limit errors must communicate retry timing (FR-011)

---

## Implementation Considerations

### Client-Side State Management

**React State Structure**:
```typescript
const [messages, setMessages] = useState<UIMessage[]>([]);
const [error, setError] = useState<ErrorState | null>(null);
const [isLoading, setIsLoading] = useState(false);
const [sessionTimeout, setSessionTimeout] = useState<NodeJS.Timeout | null>(null);
```

**Session Tracking**:
- Track `lastActivityAt` in component state or derive from `messages` array
- Use `useEffect` to manage timeout lifecycle
- Reset timeout on each message send/receive

### Message Format Compatibility

**AI SDK Compatibility**:
- Use `UIMessage` type from `@ai-sdk/react`
- Messages formatted for `useChat` hook
- API route uses `convertToModelMessages()` for conversion

**Text Extraction**:
```typescript
const textParts = message.parts?.filter((part) => part.type === 'text') || [];
const content = textParts.map((part) => 'text' in part ? part.text : '').join('');
```

---

## Future Considerations

**Out of Scope (per spec)**:
- Persistent storage across sessions
- Database integration
- Multi-user chat history
- Message editing/deletion
- File attachments

**Potential Enhancements** (future):
- Message metadata (read receipts, timestamps)
- Typing indicators
- Message reactions
- Search within conversation

---

## References

- Feature Specification: `specs/001-vercel-ai-chat/spec.md`
- Vercel AI SDK Types: https://ai-sdk.dev/docs
- React State Management: React 19 documentation

